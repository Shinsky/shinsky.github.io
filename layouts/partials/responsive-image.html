{{- $img := .img -}}
{{- $class := .class | default "post-hero" -}}
{{- $alt := .alt | default "" -}}

{{- if eq $img.MediaType.SubType "svg" -}}
{{/* SVGs can't be processed - pass through as-is */}}
<img src="{{ $img.RelPermalink }}" alt="{{ $alt }}" class="{{ $class }}">

{{- else -}}
{{/* Raster images: resize + convert to WebP with srcset */}}
{{- $origWidth := $img.Width -}}
{{- $sizes := slice 400 600 800 1200 -}}
{{- $webpSrcset := slice -}}

{{- range $sizes -}}
  {{- if le . $origWidth -}}
    {{- $resized := $img.Resize (printf "%dx webp q80" .) -}}
    {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $resized.RelPermalink .) -}}
  {{- end -}}
{{- end -}}

{{/* If image is smaller than 400px, just use original as WebP */}}
{{- if eq (len $webpSrcset) 0 -}}
  {{- $resized := $img.Resize (printf "%dx webp q80" $origWidth) -}}
  {{- $webpSrcset = $webpSrcset | append (printf "%s %dw" $resized.RelPermalink $origWidth) -}}
{{- end -}}

{{/* Fallback JPEG at 800px or original width, whichever is smaller */}}
{{- $fallbackWidth := (cond (le $origWidth 800) $origWidth 800) -}}
{{- $fallback := $img.Resize (printf "%dx jpg q85" $fallbackWidth) -}}

<picture>
    <source
        type="image/webp"
        srcset="{{ delimit $webpSrcset ", " }}"
        sizes="(max-width: 700px) 100vw, 860px">
    <img
        src="{{ $fallback.RelPermalink }}"
        alt="{{ $alt }}"
        class="{{ $class }}"
        width="{{ $fallback.Width }}"
        height="{{ $fallback.Height }}"
        loading="lazy"
        decoding="async">
</picture>
{{- end -}}
